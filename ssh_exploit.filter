#!/bin/sh
# script original: Oscar Gonzalez
# script modificat by Alfons
# per introduir dinamicament al tcp-wrappers les IP amb exploits en
# detectar-les

# per si canvio aixo de directori
LOG=/var/log/secure
FIT=/etc/hosts.deny

# si no hi ha llista d'IP, la creo
if [ ! -e $FIT ]
then
   touch $FIT
fi

# busquem les IPs des de les que mes de 5 vegades s'ha provat
# un nom inexistent ==> possiblement es l'exploit provant noms
awk '/Failed password for invalid user/ {
         gsub("(^.* from )|( port .*$)","")
         print $0
     }' $LOG | sort | uniq -c | while read num ip
do
   if (( num > 5 ))
   then
      if [ `grep -c $ip $FIT` = 0 ]
# si s'han trobat noves IPs, les afegim al hosts.allow
      then
         echo "sshd: $ip" >> $FIT
      fi
   fi
done


